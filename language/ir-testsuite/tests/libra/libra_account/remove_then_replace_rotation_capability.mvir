import 0x1.DiemAccount;
import 0x1.Signer;

main(account: &signer) {
  let sender: address;
  let old_auth_key: vector<u8>;
  let cap: DiemAccount.KeyRotationCapability;

  sender = Signer.address_of(copy(account));
  old_auth_key = DiemAccount.authentication_key(copy(sender));
  // by default, an account has not delegated its key rotation capability
  assert(!DiemAccount.delegated_key_rotation_capability(copy(sender)), 50);

  // extracting the capability should flip the flag
  cap = DiemAccount.extract_key_rotation_capability(copy(account));
  assert(DiemAccount.delegated_key_rotation_capability(copy(sender)), 51);

  // and the sender should be able to rotate
  DiemAccount.rotate_authentication_key(&cap, move(old_auth_key));

  // restoring the capability should flip the flag back
  DiemAccount.restore_key_rotation_capability(move(cap));
  assert(!DiemAccount.delegated_key_rotation_capability(copy(sender)), 52);

  return;
}

// check: "Keep(EXECUTED)"

// Extracting the capability should preclude rotation
//! new-transaction
import 0x1.DiemAccount;

main(account: &signer) {
  let cap: DiemAccount.KeyRotationCapability;
  let cap2: DiemAccount.KeyRotationCapability;

  cap = DiemAccount.extract_key_rotation_capability(copy(account));
  cap2 = DiemAccount.extract_key_rotation_capability(copy(account));
  // should fail
  DiemAccount.rotate_authentication_key(&cap2, h"00");
  DiemAccount.restore_key_rotation_capability(move(cap));
  DiemAccount.restore_key_rotation_capability(move(cap2));

  return;
}

// check: "Keep(ABORTED { code: 2305,"
// check: location: ::DiemAccount
